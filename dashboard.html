  <html lang="th">
  <head>
    <meta charset="UTF-8">
    <title>Dashboard สำรวจลูกน้ำยุงลาย</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    /* รองรับธีมมืดของอุปกรณ์ */
    @media (prefers-color-scheme: dark) {
      :root {
        --white: #181a1b;
        --light-bg: #23272a;
        --text-dark: #f1f1f1;
        --text-muted: #b0b3b8;
        --border-color: #333a40;
        --gradient-bg: linear-gradient(135deg, #23272a 0%, #181a1b 100%);
        --gradient-card: linear-gradient(135deg, #23272a 0%, #181a1b 100%);
      }
      body, .container, .header, .card, .village-card, input, select, textarea, button, .btn {
        background: #181a1b !important;
        color: #f1f1f1 !important;
        border-color: #333a40 !important;
      }
      .header {
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      }
      .card, .village-card {
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      }
      ::placeholder {
        color: #b0b3b8 !important;
        opacity: 1;
      }
    }
    /* ===== CSS Variables ===== */
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #00b894;
      --warning-color: #ffd600;
      --danger-color: #ff3b30;
      --light-bg: #f8f9fa;
      --white: #ffffff;
      --text-dark: #2d3436;
      --text-muted: #636e72;
      --border-color: #e0e6ed;
      --shadow-light: 0 2px 8px rgba(0,0,0,0.07);
      --shadow-medium: 0 8px 32px rgba(0,0,0,0.1);
      --shadow-card: 0 4px 20px rgba(102, 126, 234, 0.1);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --gradient-card: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      --border-radius: 15px;
      --border-radius-sm: 10px;
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 20px;
      --spacing-lg: 30px;
      --spacing-xl: 40px;
      --transition: all 0.3s ease;
    }

    /* ===== Base Styles ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Sarabun", "Noto Sans Thai", Arial, sans-serif;
      background: var(--gradient-bg);
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: var(--spacing-md);
    }

    /* ===== Container ===== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-medium);
      overflow: hidden;
    }

    /* ===== Header ===== */
    .header {
      background: var(--gradient-primary);
      color: white;
      padding: var(--spacing-lg) var(--spacing-md);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .header h1 {
      font-size: clamp(1.5rem, 4vw, 2.2rem);
      font-weight: 600;
      position: relative;
      z-index: 1;
      margin-bottom: var(--spacing-xs);
    }

    .header .subtitle {
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      opacity: 0.9;
      font-weight: 300;
      position: relative;
      z-index: 1;
    }

    /* ===== Controls Section ===== */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--spacing-md);
      margin: var(--spacing-lg) var(--spacing-md);
      flex-wrap: wrap;
      background: var(--gradient-card);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      min-width: 180px;
      flex: 1;
    }

    .control-group label {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.95em;
      letter-spacing: 0.3px;
    }

    .control-group select,
    .control-group input[type="date"] {
      padding: var(--spacing-sm) 16px;
      border-radius: var(--border-radius-sm);
      border: 2px solid transparent;
      background: var(--white);
      font-size: 16px;
      font-family: inherit;
      transition: var(--transition);
      box-shadow: var(--shadow-light);
      outline: none;
      width: 100%;
    }

    .control-group select:focus,
    .control-group input[type="date"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .control-group select:hover,
    .control-group input[type="date"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .loading {
      display: none;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--primary-color);
      font-weight: 500;
      padding: var(--spacing-xs) var(--spacing-md);
      background: rgba(102, 126, 234, 0.1);
      border-radius: 25px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ===== Summary Cards ===== */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-md);
      margin: var(--spacing-lg) var(--spacing-md);
    }

    .card {
      background: var(--gradient-card);
      border-radius: var(--border-radius);
      padding: 25px;
      text-align: center;
      box-shadow: var(--shadow-card);
      border: 1px solid rgba(102, 126, 234, 0.1);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-title {
      font-size: 0.95em;
      color: var(--text-muted);
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .card-value {
      font-size: clamp(2rem, 5vw, 2.5rem);
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 5px;
      line-height: 1.1;
    }

    .card-unit {
      font-size: 0.85em;
      color: var(--text-muted);
      font-weight: 400;
    }

    /* ===== CI Status Colors ===== */
    .ci-high { color: var(--danger-color) !important; }
    .ci-medium { color: var(--warning-color) !important; }
    .ci-low { color: var(--success-color) !important; }

    /* ===== Village Summary Section ===== */
    .village-summary {
      grid-column: 1 / -1;
      margin-top: 24px;
    }

    .village-summary h4 {
      margin: 0 0 var(--spacing-sm) 0;
      color: var(--primary-color);
      font-size: 1.1em;
      font-weight: 600;
    }

    .village-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .village-card {
      background: #f8fafc;
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      text-align: center;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .village-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .village-card .card-title {
      font-weight: bold;
      color: var(--text-dark);
      margin-bottom: var(--spacing-sm);
    }

    .village-stats {
      font-size: 1.1em;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .village-indices {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9em;
    }

    .village-indices span {
      color: var(--text-muted);
    }

    .village-indices .ci-value,
    .village-indices .hi-value {
      font-weight: bold;
      margin-left: 4px;
    }

    /* ===== Chart Container ===== */
    .chart-container {
      margin: var(--spacing-lg) var(--spacing-md);
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
    }

    .chart-title {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    #chart_div {
      width: 100%;
      min-height: 400px;
      border-radius: var(--border-radius-sm);
    }

    /* ===== Table Container ===== */
    .table-container {
      margin: var(--spacing-lg) var(--spacing-md) var(--spacing-md);
      background: var(--white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .table-title {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--text-dark);
      padding: var(--spacing-md);
      background: var(--light-bg);
      margin: 0;
      border-bottom: 1px solid var(--border-color);
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
      min-width: 800px;
    }

    th, td {
      padding: var(--spacing-sm) var(--spacing-xs);
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    th {
      background: var(--gradient-primary);
      color: white;
      font-weight: 600;
      font-size: 0.85em;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:nth-child(even) {
      background: rgba(248, 249, 250, 0.5);
    }

    tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    /* ===== Error & No Data States ===== */
    .error-message {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
      color: white;
      padding: var(--spacing-md);
      margin: var(--spacing-md);
      border-radius: var(--border-radius-sm);
      text-align: center;
      font-weight: 500;
      box-shadow: var(--shadow-light);
    }

    .error-message h3 {
      margin-bottom: var(--spacing-sm);
    }

    .error-message button {
      margin-top: var(--spacing-xs);
      padding: var(--spacing-xs) 16px;
      background: white;
      color: #ff6b6b;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .error-message button:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    .no-data {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
      color: var(--text-muted);
      font-size: 1.1em;
      background: var(--light-bg);
      border-radius: var(--border-radius-sm);
      margin: var(--spacing-md);
    }

    /* ===== Footer ===== */
    .footer {
      padding: var(--spacing-md);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9em;
      border-top: 1px solid var(--border-color);
      background: var(--light-bg);
    }

    /* ===== Responsive Design ===== */
    /* Large screens (1200px and up) */
    @media (min-width: 1200px) {
      .container {
        max-width: 1400px;
      }
      
      .summary-cards {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    /* Medium screens (768px to 1199px) */
    @media (max-width: 1199px) {
      .summary-cards {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    /* Tablet screens (768px to 991px) */
    @media (max-width: 991px) {
      body {
        padding: var(--spacing-sm);
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-sm);
      }

      .control-group {
        min-width: auto;
        flex: none;
      }

      .summary-cards {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-sm);
      }

      .village-cards {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      table {
        font-size: 0.8em;
      }

      th, td {
        padding: var(--spacing-xs) 6px;
      }
    }

    /* Mobile screens (576px to 767px) */
    @media (max-width: 767px) {
      body {
        padding: var(--spacing-xs);
      }

      .header {
        padding: var(--spacing-md) var(--spacing-sm);
      }

      .controls,
      .chart-container,
      .table-container {
        margin: var(--spacing-md) var(--spacing-sm);
      }

      .summary-cards {
        grid-template-columns: 1fr;
        margin: var(--spacing-md) var(--spacing-sm);
        gap: var(--spacing-sm);
      }

      .card {
        padding: var(--spacing-md);
      }

      .card-value {
        font-size: clamp(1.8rem, 8vw, 2.2rem);
      }

      .village-cards {
        grid-template-columns: 1fr;
      }

      .village-stats {
        flex-direction: column;
        gap: 4px;
      }

      .village-indices {
        justify-content: center;
        gap: var(--spacing-sm);
      }

      table {
        font-size: 0.7em;
      }

      th, td {
        padding: 6px 4px;
      }

      #chart_div {
        min-height: 300px;
      }
    }

    /* Small mobile screens (up to 575px) */
    @media (max-width: 575px) {
      .header h1 {
        font-size: 1.3rem;
      }

      .header .subtitle {
        font-size: 0.9rem;
      }

      .controls {
        padding: var(--spacing-sm);
      }

      .card {
        padding: var(--spacing-sm);
      }

      .card-value {
        font-size: 1.8rem;
      }

      table {
        font-size: 0.65em;
      }

      th, td {
        padding: 4px 2px;
      }

      .table-wrapper {
        border-radius: var(--border-radius-sm);
      }
    }

    /* Extra small screens (up to 480px) */
    @media (max-width: 480px) {
      .village-indices {
        flex-direction: column;
        gap: 4px;
      }

      .footer {
        font-size: 0.8em;
        padding: var(--spacing-sm);
      }
    }

    /* High DPI screens */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .card,
      .chart-container,
      .table-container {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --white: #1a1a1a;
        --light-bg: #2d2d2d;
        --text-dark: #ffffff;
        --text-muted: #b0b0b0;
        --border-color: #404040;
        --gradient-bg: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        --gradient-card: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
      }
    }

    /* Print styles */
    @media print {
      body {
        background: white;
        color: black;
        font-size: 12pt;
        line-height: 1.4;
      }

      .container {
        box-shadow: none;
        border: 1px solid #000;
      }

      .header {
        background: #f0f0f0 !important;
        color: black !important;
      }

      .controls {
        display: none;
      }

      .card {
        border: 1px solid #ccc;
        box-shadow: none;
        page-break-inside: avoid;
      }

      .chart-container {
        page-break-inside: avoid;
      }

      table {
        font-size: 10pt;
      }

      .footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        border-top: 1px solid #000;
      }
    }
  </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <!--<button onclick="window.history.back()" class="back-btn" aria-label="ย้อนกลับ">
          <span class="back-icon" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.5 18L8 11L14.5 4" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="back-text">ย้อนกลับ</span>
        </button>-->
    <style>
    .back-btn {
      position: absolute;
      left: 20px;
      top: 20px;
      padding: 8px 18px 8px 12px;
      font-size: 1em;
      border-radius: 8px;
      border: 1.5px solid #bbb;
      background: #fff;
      color: #222;
      cursor: pointer;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    .back-btn:hover {
      background: #f0f0f0;
      border-color: #888;
    }
    .back-icon {
      display: flex;
      align-items: center;
      height: 22px;
    }
    .back-text {
      font-size: 1em;
      font-family: inherit;
    }
    @media (prefers-color-scheme: dark) {
      .back-btn {
        background: #23272a;
        color: #f1f1f1;
        border-color: #444;
      }
      .back-btn:hover {
        background: #181a1b;
        border-color: #888;
      }
    }
    </style>
    <style>
    .back-btn {
      position: absolute;
      left: 20px;
      top: 20px;
      padding: 8px 18px;
      font-size: 1em;
      border-radius: 8px;
      border: 1.5px solid #bbb;
      background: #fff;
      color: #222;
      cursor: pointer;
      z-index: 2;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    .back-btn:hover {
      background: #f0f0f0;
      border-color: #888;
    }
    @media (prefers-color-scheme: dark) {
      .back-btn {
        background: #23272a;
        color: #f1f1f1;
        border-color: #444;
      }
      .back-btn:hover {
        background: #181a1b;
        border-color: #888;
      }
    }
    </style>
        <h1>📊 Dashboard สำรวจลูกน้ำยุงลาย รพ.สต.นาอิน</h1>
        <p class="subtitle">ระบบติดตามและวิเคราะห์ข้อมูลการสำรวจ</p>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="mooSelect">🏘️ เลือกหมู่:</label>
          <select id="mooSelect">
            <option value="">ทุกหมู่</option>
          </select>
        </div>
        <div class="control-group">
          <label for="dateSelect">📅 เลือกวันที่:</label>
          <input type="date" id="dateSelect">
        </div>
        <div class="control-group">
          <label for="osmoSelect">👤 ชื่อ อสม:</label>
          <select id="osmoSelect">
            <option value="">กำลังโหลด...</option>
          </select>
        </div>
        <div class="loading" id="loading">
          <span>⏳</span>
          <span>กำลังโหลดข้อมูล...</span>
        </div>
      </div>

      <div class="summary-cards" id="summaryCards">
        <!-- Summary cards will be populated here -->
      </div>

      <div class="chart-container">
        <h3 class="chart-title">📈 Container Index (CI),House Index (HI) แยกตามหมู่บ้าน</h3>
        <div id="chart_div"></div>
      </div>

      <div class="table-container">
        <h3 class="table-title">📋 รายละเอียดการสำรวจ</h3>
        <div class="table-wrapper">
          <div id="table_div"></div>
        </div>
      </div>

      <div class="footer">
        <p>💡 <strong>คำแนะนำ:</strong> ค่า CI ที่สูงกว่า 10% ถือว่าอยู่ในระดับเสี่ยงสูง | ระบบอัพเดทข้อมูลแบบเรียลไทม์</p>
      </div>
    </div>

    <script>
      // กำหนดค่า Google Sheet
      const SHEET_ID = '15r7y6xwbVB4_cc6IMTqmsV93JHXQqHIIdQbn9kMAF3A';
      const SHEET_NAME = 'Sheet1ID178';
      const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}`;

      let rawData = [];
      let dateList = [];
      let osmoList = [];
      let currentDateCol = null;
      let currentOsmoCol = null;
      // เพิ่มตัวแปรสำหรับคอลัมน์บ้านเลขที่และหมู่
      let houseNoCol = null;
      let villageCol = null;

      // โหลด Google Charts
      google.charts.load('current', {
        'packages': ['corechart', 'table'],
        'language': 'th'
      });
      google.charts.setOnLoadCallback(init);

      function init() {
        showLoading(true);
        fetchData();
      }

      function showLoading(show) {
        const loading = document.getElementById('loading');
        loading.style.display = show ? 'flex' : 'none';
      }

      function showError(message) {
        const container = document.querySelector('.container');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
          <h3>⚠️ เกิดข้อผิดพลาด</h3>
          <p>${message}</p>
          <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: white; color: #ff6b6b; border: none; border-radius: 5px; cursor: pointer;">ลองใหม่</button>
        `;
        container.insertBefore(errorDiv, container.children[1]);
      }

      function fetchData() {
        const query = new google.visualization.Query(sheetUrl);
        query.send(function(response) {
          showLoading(false);
          
          if (response.isError()) {
            console.error('Error fetching data:', response.getMessage());
            showError(`ไม่สามารถโหลดข้อมูลได้: ${response.getMessage()}<br><br>
              <small>โปรดตรวจสอบ:<br>
              • การเชื่อมต่ออินเทอร์เน็ต<br>
              • การตั้งค่าการแชร์ Google Sheet (ต้องเป็น "Anyone with the link can view")<br>
              • SHEET_ID และ SHEET_NAME ในโค้ด</small>`);
            return;
          }

          try {
            const dataTable = response.getDataTable();
            const cols = [];
            
            for (let i = 0; i < dataTable.getNumberOfColumns(); i++) {
              cols.push(dataTable.getColumnLabel(i));
            }
            
            const rows = [];
            for (let i = 0; i < dataTable.getNumberOfRows(); i++) {
              const row = [];
              for (let j = 0; j < cols.length; j++) {
                row.push(dataTable.getValue(i, j));
              }
              rows.push(row);
            }

            rawData = rows.map(row => {
              let obj = {};
              cols.forEach((col, i) => obj[col] = row[i]);
              return obj;
            });

            console.log('Columns found:', cols);
            console.log('Sample data:', rawData.slice(0, 2));

            // หาคอลัมน์วันที่และผู้สำรวจ
            currentDateCol = findColumn(cols, ['วันที่สำรวจ', 'วันที่', 'surveyDate']);
            currentOsmoCol = findColumn(cols, ['ผู้สำรวจ', 'อสม', 'surveyor']);

            // เพิ่มตัวแปรสำหรับคอลัมน์บ้านเลขที่และหมู่
            houseNoCol = findColumn(cols, ['บ้านเลขที่', 'houseNos', 'เลขที่', 'house_no']);
            villageCol = findColumn(cols, ['หมู่', 'village', 'หมู่ที่', 'village_no']);

            if (!currentDateCol || !currentOsmoCol || !houseNoCol || !villageCol) {
              throw new Error(`ไม่พบคอลัมน์ที่จำเป็น: วันที่=${currentDateCol}, ผู้สำรวจ=${currentOsmoCol}, บ้านเลขที่=${houseNoCol}, หมู่=${villageCol}`);
            }

            processDateData();
            renderDateSelect();
            renderMooSelect(rawData);
            
          } catch (error) {
            console.error('Error processing data:', error);
            showError(`เกิดข้อผิดพลาดในการประมวลผลข้อมูล: ${error.message}`);
          }
        });
      }

      function findColumn(cols, possibleNames) {
        for (let name of possibleNames) {
          const found = cols.find(col => 
            col.replace(/\s/g, '').toLowerCase().includes(name.replace(/\s/g, '').toLowerCase())
          );
          if (found) return found;
        }
        return null;
      }

      function processDateData() {
        const validDates = rawData
          .map(r => r[currentDateCol])
          .filter(Boolean)
          .map(raw => {
            const d = new Date(raw);
            if (isNaN(d.getTime())) return null;
            
            const yyyy = d.getFullYear();
            const mm = (d.getMonth() + 1).toString().padStart(2, '0');
            const dd = d.getDate().toString().padStart(2, '0');
            
            return { raw, date: `${yyyy}-${mm}-${dd}` };
          })
          .filter(Boolean);

        dateList = [...new Map(validDates.map(item => [item.date, item])).values()]
          .sort((a, b) => b.date.localeCompare(a.date));
      }

      function renderDateSelect() {
        const input = document.getElementById('dateSelect');
        
        if (!dateList.length) {
          input.disabled = true;
          input.value = '';
          renderOsmoSelect();
          return;
        }

        input.disabled = false;
        input.min = dateList[dateList.length - 1].date;
        input.max = dateList[0].date;
        
        if (!input.value || input.value < input.min || input.value > input.max) {
          input.value = dateList[0].date;
        }

        input.removeEventListener('change', onDateChange);
        input.addEventListener('change', onDateChange);
        onDateChange();
      }

      function onDateChange() {
        // กรองข้อมูลเฉพาะวันที่ที่เลือก แล้วส่งให้ renderMooSelect
        const selectedDate = document.getElementById('dateSelect').value;
        let filteredData = rawData;
        if (selectedDate) {
          filteredData = rawData.filter(r => {
            const d = new Date(r[currentDateCol]);
            if (isNaN(d.getTime())) return false;
            const yyyy = d.getFullYear();
            const mm = (d.getMonth() + 1).toString().padStart(2, '0');
            const dd = d.getDate().toString().padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            return dateStr === selectedDate;
          });
        }
        renderMooSelect(filteredData);
      }

      function renderOsmoSelect() {
        const dateInput = document.getElementById('dateSelect');
        const selectedDate = dateInput.value;
        const selectedMoo = getSelectedMoo();

        if (!selectedDate) {
          document.getElementById('summaryCards').innerHTML = '<div class="no-data">กรุณาเลือกวันที่</div>';
          return;
        }

        // กรองข้อมูลตามวันที่และหมู่
        let filteredData = rawData.filter(r => {
          const d = new Date(r[currentDateCol]);
          if (isNaN(d.getTime())) return false;
          const yyyy = d.getFullYear();
          const mm = (d.getMonth() + 1).toString().padStart(2, '0');
          const dd = d.getDate().toString().padStart(2, '0');
          const dateStr = `${yyyy}-${mm}-${dd}`;
          return dateStr === selectedDate;
        });
        if (selectedMoo) {
          filteredData = filteredData.filter(r => {
            let v = r[villageCol] || r['หมู่'] || r['หมู่ที่'] || '';
            return String(v).trim() === String(selectedMoo).trim();
          });
        }

        osmoList = [...new Set(filteredData.map(r => r[currentOsmoCol]).filter(Boolean))];

        const select = document.getElementById('osmoSelect');
        if (osmoList.length === 0) {
          select.innerHTML = '<option value="">ไม่มีข้อมูล</option>';
          select.value = '';
        } else {
          select.innerHTML = '<option value="">ทั้งหมด</option>';
          osmoList.forEach(osmo => {
            const option = document.createElement('option');
            option.value = osmo;
            option.textContent = osmo;
            select.appendChild(option);
          });
          select.value = '';
        }
        select.removeEventListener('change', renderDashboard);
        select.addEventListener('change', renderDashboard);

        renderDashboard();
      }

      // --- หมู่บ้าน Dropdown ---
      function renderMooSelect(data) {
        const select = document.getElementById('mooSelect');
        if (!select) return;
        // หา unique หมู่
        const mooSet = new Set();
        data.forEach(r => {
          let v = r[villageCol] || r['หมู่'] || r['หมู่ที่'] || '';
          if (v && v !== 'ไม่ระบุ') mooSet.add(v);
        });
        const mooList = Array.from(mooSet).sort((a,b) => String(a).localeCompare(String(b), 'th'));
        select.innerHTML = '<option value="">ทุกหมู่</option>' + mooList.map(moo => `<option value="${moo}">${moo}</option>`).join('');
        select.removeEventListener('change', onMooChange);
        select.addEventListener('change', onMooChange);
        onMooChange();
      }

      function onMooChange() {
        // กรองข้อมูลตามวันที่และหมู่ แล้วส่งให้ renderOsmoSelect
        const selectedDate = document.getElementById('dateSelect').value;
        const selectedMoo = getSelectedMoo();
        let filteredData = rawData;
        if (selectedDate) {
          filteredData = rawData.filter(r => {
            const d = new Date(r[currentDateCol]);
            if (isNaN(d.getTime())) return false;
            const yyyy = d.getFullYear();
            const mm = (d.getMonth() + 1).toString().padStart(2, '0');
            const dd = d.getDate().toString().padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            return dateStr === selectedDate;
          });
        }
        if (selectedMoo) {
          filteredData = filteredData.filter(r => {
            let v = r[villageCol] || r['หมู่'] || r['หมู่ที่'] || '';
            return String(v).trim() === String(selectedMoo).trim();
          });
        }
        renderOsmoSelect(filteredData);
      }

      function getSelectedMoo() {
        const el = document.getElementById('mooSelect');
        return el ? el.value : '';
      }

      function renderDashboard() {
        const dateInput = document.getElementById('dateSelect');
        const osmoSelect = document.getElementById('osmoSelect');
        const selectedDate = dateInput.value;
        const selectedOsmo = osmoSelect.value;
        const selectedMoo = getSelectedMoo();

        if (!selectedDate) return;

        let filteredData = rawData.filter(r => {
          const d = new Date(r[currentDateCol]);
          if (isNaN(d.getTime())) return false;
          const yyyy = d.getFullYear();
          const mm = (d.getMonth() + 1).toString().padStart(2, '0');
          const dd = d.getDate().toString().padStart(2, '0');
          const dateStr = `${yyyy}-${mm}-${dd}`;
          return dateStr === selectedDate;
        });

        if (selectedOsmo) {
          filteredData = filteredData.filter(r => r[currentOsmoCol] === selectedOsmo);
        }
        if (selectedMoo) {
          filteredData = filteredData.filter(r => {
            let v = r[villageCol] || r['หมู่'] || r['หมู่ที่'] || '';
            return String(v).trim() === String(selectedMoo).trim();
          });
        }

        if (filteredData.length === 0) {
          document.getElementById('summaryCards').innerHTML = '<div class="no-data">ไม่พบข้อมูลในวันที่เลือก</div>';
          document.getElementById('chart_div').innerHTML = '';
          document.getElementById('table_div').innerHTML = '';
          return;
        }

        renderSummaryCards(filteredData, selectedOsmo);
        renderChart(filteredData);
        renderTable(filteredData);
      }

      function renderSummaryCards(data, selectedOsmo) {
        let totalSurvey = 0, totalFound = 0, houseCount = data.length;

        // --- Group by village ---
        // สร้าง object สำหรับแยกหมู่
        const villageMap = {};
        data.forEach(r => {
          const village = r[villageCol] || r['หมู่'] || r['หมู่ที่'] || 'ไม่ระบุ';
          if (!villageMap[village]) villageMap[village] = [];
          villageMap[village].push(r);
        });

        // --- สรุปภาพรวมทั้งหมด ---
        data.forEach(r => {
          const survey = parseInt(r['รวมสำรวจ']) || 0;
          const found = parseInt(r['รวมพบลูกน้ำ']) || 0;
          totalSurvey += survey;
          totalFound += found;
        });

        const ci = totalSurvey > 0 ? (totalFound / totalSurvey) * 100 : 0;
        const ciClass = ci > 10 ? 'ci-high' : ci > 5 ? 'ci-medium' : 'ci-low';

        // --- HI (House Index) รวม ---
        let houseFound = 0;
        data.forEach(r => {
          const found = parseInt(r['รวมพบลูกน้ำ']) || 0;
          if (found > 0) houseFound++;
        });
        const hi = houseCount > 0 ? (houseFound / houseCount) * 100 : 0;
        const hiClass = hi > 10 ? 'ci-high' : hi > 5 ? 'ci-medium' : 'ci-low';

        // --- Summary Cards (รวมทุกหมู่) ---
        let summaryHtml = `
        <div class="card">
          <div class="card">
            <div class="card-title">🏠 จำนวนบ้านที่สำรวจ</div>
            <div class="card-value">${houseCount}</div>
            <div class="card-unit">บ้าน</div>
          </div>
          <div class="card">
            <div class="card-title">🏡 <b>บ้านที่ตรวจพบลูกน้ำ</b></div>
            <div class="card-value" style="color:#764ba2;">${houseFound}</div>
            <div class="card-unit">บ้าน</div>
          </div>
          <div class="card">
            <div class="card-title"><b>HI (House Index)</b></div>
            <div class="card-value ${hiClass}">${hi.toFixed(2)}</div>
            <div class="card-unit">%</div>
          </div>
        </div>
        <div class="card">
          <div class="card">
            <div class="card-title">🔍 รวมสำรวจทั้งหมด</div>
            <div class="card-value">${totalSurvey}</div>
            <div class="card-unit">ภาชนะ</div>
          </div>
          <div class="card">
            <div class="card-title">⚠️ รวมพบลูกน้ำ</div>
            <div class="card-value">${totalFound}</div>
            <div class="card-unit">ภาชนะ</div>
          </div>
          <div class="card">
            <div class="card-title">📊 Container Index (CI)</div>
            <div class="card-value ${ciClass}">${ci.toFixed(2)}</div>
            <div class="card-unit">%</div>
          </div>
          </div>
          ${selectedOsmo ? `
          <div class="card">
            <div class="card-title">👤 ${selectedOsmo}</div>
            <div class="card-value">${houseCount}</div>
            <div class="card-unit">บ้านที่สำรวจ</div>
          </div>
          ` : ''}
        `;

        // --- รายงานแยกหมู่ ---
        summaryHtml += `<div style="grid-column: 1/-1; margin-top:24px;">
          <h4 style="margin:0 0 10px 0; color:#667eea;">สรุปแยกตามหมู่</h4>
          <div style="display:flex; flex-wrap:wrap; gap:16px;">`;

        Object.entries(villageMap).forEach(([village, arr]) => {
          const vHouse = arr.length;
          let vSurvey = 0, vFound = 0, vHouseFound = 0;
          arr.forEach(r => {
            vSurvey += parseInt(r['รวมสำรวจ']) || 0;
            const found = parseInt(r['รวมพบลูกน้ำ']) || 0;
            vFound += found;
            if (found > 0) vHouseFound++;
          });
          const vCI = vSurvey > 0 ? (vFound / vSurvey) * 100 : 0;
          const vHI = vHouse > 0 ? (vHouseFound / vHouse) * 100 : 0;
          const vCIClass = vCI > 10 ? 'ci-high' : vCI > 5 ? 'ci-medium' : 'ci-low';
          const vHIClass = vHI > 10 ? 'ci-high' : vHI > 5 ? 'ci-medium' : 'ci-low';

          summaryHtml += `
            <div class="card" style="min-width:220px; flex:1 1 220px; background:#f8fafc;">
              <div class="card-title" style="font-weight:bold;">หมู่ ${village}</div>
              <div style="font-size:1.1em; margin-bottom:6px;">
              </div>
              <div>
                <span style="color:#636e72;">CI: </span>
                <span class="${vCIClass}" style="font-weight:bold;">${vCI.toFixed(2)}%</span>
                <span style="margin-left:10px; color:#636e72;">HI: </span>
                <span class="${vHIClass}" style="font-weight:bold;">${vHI.toFixed(2)}%</span>
              </div>
            </div>
          `;
        });

        summaryHtml += `</div></div>`;

        document.getElementById('summaryCards').innerHTML = summaryHtml;
      }

      function renderChart(data) {
        const byVillage = {};
        data.forEach(r => {
          const village = r['หมู่ที่'] || r['หมู่'] || 'ไม่ระบุ';
          const survey = parseInt(r['รวมสำรวจ']) || 0;
          const found = parseInt(r['รวมพบลูกน้ำ']) || 0;
          if (!byVillage[village]) {
            byVillage[village] = { survey: 0, found: 0, count: 0, houseFound: 0 };
          }
          byVillage[village].survey += survey;
          byVillage[village].found += found;
          byVillage[village].count++;
          if (found > 0) byVillage[village].houseFound++;
        });


        const chartData = new google.visualization.DataTable();
        chartData.addColumn('string', 'หมู่ที่');
        chartData.addColumn('number', 'CI (%)');
        chartData.addColumn({type: 'string', role: 'annotation'});
        chartData.addColumn('number', 'HI (%)');
        chartData.addColumn({type: 'string', role: 'annotation'});

        Object.entries(byVillage).forEach(([village, val]) => {
          const ci = val.survey > 0 ? (val.found / val.survey) * 100 : 0;
          const hi = val.count > 0 ? (val.houseFound / val.count) * 100 : 0;
          chartData.addRow([
            `หมู่ ${village}`,
            ci, ci.toFixed(1) + '%',
            hi, hi.toFixed(1) + '%'
          ]);
        });

        const options = {
          title: '',
          height: 400,
          fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif',
          legend: {
            position: 'top',
            alignment: 'center',
            textStyle: {
              fontSize: 15,
              color: getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '#667eea',
              fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif'
            }
          },
          hAxis: {
            title: 'หมู่บ้าน',
            titleTextStyle: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted') || '#636e72',
              fontSize: 13,
              fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif'
            },
            textStyle: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark') || '#2d3436',
              fontSize: 13,
              fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif'
            }
          },
          vAxis: {
            title: 'Index (%)',
            titleTextStyle: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted') || '#636e72',
              fontSize: 13,
              fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif'
            },
            textStyle: {
              color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark') || '#2d3436',
              fontSize: 13,
              fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif'
            },
            minValue: 0,
            maxValue: Math.max(20, ...Object.values(byVillage).map(v => Math.max(
              v.survey > 0 ? (v.found / v.survey) * 100 : 0,
              v.count > 0 ? (v.houseFound / v.count) * 100 : 0
            )) + 5)
          },
          backgroundColor: 'transparent',
          chartArea: { left: 60, top: 20, width: '85%', height: '75%' },
          bar: { groupWidth: '70%' },
          colors: [
            getComputedStyle(document.documentElement).getPropertyValue('--danger-color') || '#ff3b30',
            getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '#667eea'
          ],
          annotations: {
            textStyle: {
              fontSize: 14,
              color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-color') || '#764ba2',
              auraColor: 'none',
              fontName: 'Sarabun, Noto Sans Thai, Arial, sans-serif',
              bold: true
            }
          }
        };

        // Add card style to chart container for consistency
        const chartDiv = document.getElementById('chart_div');
        chartDiv.style.background = getComputedStyle(document.documentElement).getPropertyValue('--gradient-card') || '#fff';
        chartDiv.style.borderRadius = getComputedStyle(document.documentElement).getPropertyValue('--border-radius') || '15px';
        chartDiv.style.boxShadow = getComputedStyle(document.documentElement).getPropertyValue('--shadow-card') || '0 4px 20px rgba(102, 126, 234, 0.1)';
        chartDiv.style.border = '1px solid ' + (getComputedStyle(document.documentElement).getPropertyValue('--border-color') || '#e0e6ed');
        chartDiv.style.padding = '16px 8px 8px 8px';

        const chart = new google.visualization.ColumnChart(chartDiv);

        function drawResponsiveChart() {
          let responsiveOptions = { ...options };
          const width = window.innerWidth;
          if (width < 600) {
            responsiveOptions.chartArea = { left: 20, top: 20, width: '92%', height: '60%' };
            responsiveOptions.height = 260;
            responsiveOptions.legend = { position: 'top', alignment: 'center', textStyle: { fontSize: 12, color: options.legend.textStyle.color } };
            responsiveOptions.hAxis = { ...responsiveOptions.hAxis, titleTextStyle: { ...responsiveOptions.hAxis.titleTextStyle, fontSize: 10 }, textStyle: { ...responsiveOptions.hAxis.textStyle, fontSize: 10 } };
            responsiveOptions.vAxis = { ...responsiveOptions.vAxis, titleTextStyle: { ...responsiveOptions.vAxis.titleTextStyle, fontSize: 10 }, textStyle: { ...responsiveOptions.vAxis.textStyle, fontSize: 10 } };
            responsiveOptions.annotations = { ...responsiveOptions.annotations, alwaysOutside: true, textStyle: { ...responsiveOptions.annotations.textStyle, fontSize: 12 } };
          } else {
            responsiveOptions.annotations = { ...responsiveOptions.annotations, alwaysOutside: false };
          }
          chart.draw(chartData, responsiveOptions);
        }

        drawResponsiveChart();
        window.addEventListener('resize', drawResponsiveChart);
      }

      function renderTable(data) {
        if (data.length === 0) {
          document.getElementById('table_div').innerHTML = '<div class="no-data">ไม่มีข้อมูลที่จะแสดง</div>';
          return;
        }

        let html = `<table>
          <tr>
            <th rowspan="2">บ้านเลขที่</th>
            <th rowspan="2">หมู่</th>
            <th rowspan="2">ผู้สำรวจ</th>
            <th colspan="6">ในอาคาร</th>
            <th colspan="6">นอกอาคาร</th>
            <th rowspan="2">รวมสำรวจ</th>
            <th rowspan="2">รวมพบลูกน้ำ</th>
            <th rowspan="2">CI (%)</th>
          </tr>
          <tr>
            <th>น้ำใช้</th>
            <th>น้ำดื่ม</th>
            <th>ห้องน้ำ</th>
            <th>แจกัน/กระถาง</th>
            <th>อื่นๆ</th>
            <th>อื่นๆ รายละเอียด</th>
            <th>น้ำใช้</th>
            <th>น้ำดื่ม</th>
            <th>ห้องน้ำ</th>
            <th>แจกัน/กระถาง</th>
            <th>อื่นๆ</th>
            <th>อื่นๆ รายละเอียด</th>
          </tr>`;

        // --- เตรียมตัวแปรรวม ---
        let sum = {
          inUse: [0, 0], inDrink: [0, 0], inToilet: [0, 0], inFlower: [0, 0], inOther: [0, 0],
          outUse: [0, 0], outDrink: [0, 0], outToilet: [0, 0], outFlower: [0, 0], outOther: [0, 0],
          totalSurvey: 0, totalFound: 0
        };

        data.forEach(r => {
          let houseNo = r[houseNoCol];
          if (houseNo === undefined || houseNo === null || houseNo === '') {
            houseNo = '-';
          } else {
            houseNo = String(houseNo);
          }

          const village = r[villageCol] || '-';
          const surveyor = r[currentOsmoCol] || '-';

          const inUse = [Number(r['ในอาคาร-น้ำใช้-สำรวจ']) || 0, Number(r['ในอาคาร-น้ำใช้-พบลูกน้ำ']) || 0];
          const inDrink = [Number(r['ในอาคาร-น้ำดื่ม-สำรวจ']) || 0, Number(r['ในอาคาร-น้ำดื่ม-พบลูกน้ำ']) || 0];
          const inToilet = [Number(r['ในอาคาร-ห้องน้ำ-สำรวจ']) || 0, Number(r['ในอาคาร-ห้องน้ำ-พบลูกน้ำ']) || 0];
          const inFlower = [Number(r['ในอาคาร-แจกันกระถาง-สำรวจ']) || 0, Number(r['ในอาคาร-แจกันกระถาง-พบลูกน้ำ']) || 0];
          const inOther = [Number(r['ในอาคาร-อื่นๆ-สำรวจ']) || 0, Number(r['ในอาคาร-อื่นๆ-พบลูกน้ำ']) || 0];
          let inOtherDesc = r['ในอาคาร-อื่นๆ-รายละเอียด'] || '';
          if (Array.isArray(inOtherDesc)) inOtherDesc = inOtherDesc.join(', ');
          if (typeof inOtherDesc === 'string' && inOtherDesc.includes(',')) {
            inOtherDesc = inOtherDesc.split(',').map(s => s.trim()).filter(Boolean).join('<br>');
          }

          const outUse = [Number(r['นอกอาคาร-น้ำใช้-สำรวจ']) || 0, Number(r['นอกอาคาร-น้ำใช้-พบลูกน้ำ']) || 0];
          const outDrink = [Number(r['นอกอาคาร-น้ำดื่ม-สำรวจ']) || 0, Number(r['นอกอาคาร-น้ำดื่ม-พบลูกน้ำ']) || 0];
          const outToilet = [Number(r['นอกอาคาร-ห้องน้ำ-สำรวจ']) || 0, Number(r['นอกอาคาร-ห้องน้ำ-พบลูกน้ำ']) || 0];
          const outFlower = [Number(r['นอกอาคาร-แจกันกระถาง-สำรวจ']) || 0, Number(r['นอกอาคาร-แจกันกระถาง-พบลูกน้ำ']) || 0];
          const outOther = [Number(r['นอกอาคาร-อื่นๆ-สำรวจ']) || 0, Number(r['นอกอาคาร-อื่นๆ-พบลูกน้ำ']) || 0];
          let outOtherDesc = r['นอกอาคาร-อื่นๆ-รายละเอียด'] || '';
          if (Array.isArray(outOtherDesc)) outOtherDesc = outOtherDesc.join(', ');
          if (typeof outOtherDesc === 'string' && outOtherDesc.includes(',')) {
            outOtherDesc = outOtherDesc.split(',').map(s => s.trim()).filter(Boolean).join('<br>');
          }

          const totalSurvey = Number(r['รวมสำรวจ']) || 0;
          const totalFound = Number(r['รวมพบลูกน้ำ']) || 0;
          const ci = totalSurvey > 0 ? (totalFound / totalSurvey) * 100 : 0;
          const ciClass = ci > 10 ? 'ci-high' : ci > 5 ? 'ci-medium' : 'ci-low';

          // รวมค่า
          sum.inUse[0] += inUse[0]; sum.inUse[1] += inUse[1];
          sum.inDrink[0] += inDrink[0]; sum.inDrink[1] += inDrink[1];
          sum.inToilet[0] += inToilet[0]; sum.inToilet[1] += inToilet[1];
          sum.inFlower[0] += inFlower[0]; sum.inFlower[1] += inFlower[1];
          sum.inOther[0] += inOther[0]; sum.inOther[1] += inOther[1];
          sum.outUse[0] += outUse[0]; sum.outUse[1] += outUse[1];
          sum.outDrink[0] += outDrink[0]; sum.outDrink[1] += outDrink[1];
          sum.outToilet[0] += outToilet[0]; sum.outToilet[1] += outToilet[1];
          sum.outFlower[0] += outFlower[0]; sum.outFlower[1] += outFlower[1];
          sum.outOther[0] += outOther[0]; sum.outOther[1] += outOther[1];
          sum.totalSurvey += totalSurvey;
          sum.totalFound += totalFound;

          html += `
          <tr>
            <td><strong>${houseNo}</strong></td>
            <td>${village}</td>
            <td>${surveyor}</td>
            <td>${inUse[0]}/${inUse[1]}</td>
            <td>${inDrink[0]}/${inDrink[1]}</td>
            <td>${inToilet[0]}/${inToilet[1]}</td>
            <td>${inFlower[0]}/${inFlower[1]}</td>
            <td>${inOther[0]}/${inOther[1]}</td>
            <td>${inOtherDesc ? inOtherDesc : '-'}</td>
            <td>${outUse[0]}/${outUse[1]}</td>
            <td>${outDrink[0]}/${outDrink[1]}</td>
            <td>${outToilet[0]}/${outToilet[1]}</td>
            <td>${outFlower[0]}/${outFlower[1]}</td>
            <td>${outOther[0]}/${outOther[1]}</td>
            <td>${outOtherDesc ? outOtherDesc : '-'}</td>
            <td><strong>${totalSurvey}</strong></td>
            <td><strong>${totalFound}</strong></td>
            <td><strong class="${ciClass}">${ci.toFixed(2)}%</strong></td>
          </tr>`;
        });

        // --- แถวรวม ---
        const sumCI = sum.totalSurvey > 0 ? (sum.totalFound / sum.totalSurvey) * 100 : 0;
        const sumCIClass = sumCI > 10 ? 'ci-high' : sumCI > 5 ? 'ci-medium' : 'ci-low';

        html += `
          <tr style="background:#e0e6ed;font-weight:bold;">
            <td colspan="3" style="text-align:right;">รวม</td>
            <td>${sum.inUse[0]}/${sum.inUse[1]}</td>
            <td>${sum.inDrink[0]}/${sum.inDrink[1]}</td>
            <td>${sum.inToilet[0]}/${sum.inToilet[1]}</td>
            <td>${sum.inFlower[0]}/${sum.inFlower[1]}</td>
            <td>${sum.inOther[0]}/${sum.inOther[1]}</td>
            <td></td>
            <td>${sum.outUse[0]}/${sum.outUse[1]}</td>
            <td>${sum.outDrink[0]}/${sum.outDrink[1]}</td>
            <td>${sum.outToilet[0]}/${sum.outToilet[1]}</td>
            <td>${sum.outFlower[0]}/${sum.outFlower[1]}</td>
            <td>${sum.outOther[0]}/${sum.outOther[1]}</td>
            <td></td>
            <td><strong>${sum.totalSurvey}</strong></td>
            <td><strong>${sum.totalFound}</strong></td>
            <td><strong class="${sumCIClass}">${sumCI.toFixed(2)}%</strong></td>
          </tr>
        `;

        html += `</table>`;
        // --- สรุปการพบลูกน้ำแยกตามประเภท (card summary) ---
        // เตรียมข้อมูลรวมแต่ละประเภท (เฉพาะ "พบลูกน้ำ")
        const foundSummary = {
          'ในอาคาร-น้ำใช้': 0,
          'ในอาคาร-น้ำดื่ม': 0,
          'ในอาคาร-ห้องน้ำ': 0,
          'ในอาคาร-แจกันกระถาง': 0,
          'ในอาคาร-อื่นๆ': 0,
          'นอกอาคาร-น้ำใช้': 0,
          'นอกอาคาร-น้ำดื่ม': 0,
          'นอกอาคาร-ห้องน้ำ': 0,
          'นอกอาคาร-แจกันกระถาง': 0,
          'นอกอาคาร-อื่นๆ': 0
        };
        data.forEach(r => {
          foundSummary['ในอาคาร-น้ำใช้'] += Number(r['ในอาคาร-น้ำใช้-พบลูกน้ำ']) || 0;
          foundSummary['ในอาคาร-น้ำดื่ม'] += Number(r['ในอาคาร-น้ำดื่ม-พบลูกน้ำ']) || 0;
          foundSummary['ในอาคาร-ห้องน้ำ'] += Number(r['ในอาคาร-ห้องน้ำ-พบลูกน้ำ']) || 0;
          foundSummary['ในอาคาร-แจกันกระถาง'] += Number(r['ในอาคาร-แจกันกระถาง-พบลูกน้ำ']) || 0;
          foundSummary['ในอาคาร-อื่นๆ'] += Number(r['ในอาคาร-อื่นๆ-พบลูกน้ำ']) || 0;
          foundSummary['นอกอาคาร-น้ำใช้'] += Number(r['นอกอาคาร-น้ำใช้-พบลูกน้ำ']) || 0;
          foundSummary['นอกอาคาร-น้ำดื่ม'] += Number(r['นอกอาคาร-น้ำดื่ม-พบลูกน้ำ']) || 0;
          foundSummary['นอกอาคาร-ห้องน้ำ'] += Number(r['นอกอาคาร-ห้องน้ำ-พบลูกน้ำ']) || 0;
          foundSummary['นอกอาคาร-แจกันกระถาง'] += Number(r['นอกอาคาร-แจกันกระถาง-พบลูกน้ำ']) || 0;
          foundSummary['นอกอาคาร-อื่นๆ'] += Number(r['นอกอาคาร-อื่นๆ-พบลูกน้ำ']) || 0;
        });

        // รวมข้อมูลเพิ่มเติม
        const totalIn = foundSummary['ในอาคาร-น้ำใช้'] + foundSummary['ในอาคาร-น้ำดื่ม'] + foundSummary['ในอาคาร-ห้องน้ำ'] + foundSummary['ในอาคาร-แจกันกระถาง'] + foundSummary['ในอาคาร-อื่นๆ'];
        const totalOut = foundSummary['นอกอาคาร-น้ำใช้'] + foundSummary['นอกอาคาร-น้ำดื่ม'] + foundSummary['นอกอาคาร-ห้องน้ำ'] + foundSummary['นอกอาคาร-แจกันกระถาง'] + foundSummary['นอกอาคาร-อื่นๆ'];
        const totalAll = totalIn + totalOut;
        // อันดับที่พบมากสุด
        const allTypes = [
          { label: 'ในอาคาร - น้ำใช้', value: foundSummary['ในอาคาร-น้ำใช้'] },
          { label: 'ในอาคาร - น้ำดื่ม', value: foundSummary['ในอาคาร-น้ำดื่ม'] },
          { label: 'ในอาคาร - ห้องน้ำ', value: foundSummary['ในอาคาร-ห้องน้ำ'] },
          { label: 'ในอาคาร - แจกัน/กระถาง', value: foundSummary['ในอาคาร-แจกันกระถาง'] },
          { label: 'ในอาคาร - อื่นๆ', value: foundSummary['ในอาคาร-อื่นๆ'] },
          { label: 'นอกอาคาร - น้ำใช้', value: foundSummary['นอกอาคาร-น้ำใช้'] },
          { label: 'นอกอาคาร - น้ำดื่ม', value: foundSummary['นอกอาคาร-น้ำดื่ม'] },
          { label: 'นอกอาคาร - ห้องน้ำ', value: foundSummary['นอกอาคาร-ห้องน้ำ'] },
          { label: 'นอกอาคาร - แจกัน/กระถาง', value: foundSummary['นอกอาคาร-แจกันกระถาง'] },
          { label: 'นอกอาคาร - อื่นๆ', value: foundSummary['นอกอาคาร-อื่นๆ'] }
        ];
        const sortedTypes = allTypes.slice().sort((a,b)=>b.value-a.value);
        // เปอร์เซ็นต์แต่ละประเภท
        const percent = t => totalAll > 0 ? ((t/totalAll)*100).toFixed(1) : '0.0';

        // Pie chart container
        html += `<div style="display:flex;flex-wrap:wrap;gap:24px;justify-content:center;margin:36px 0 0 0;align-items:flex-start;">
          <div style="flex:2 1 400px;min-width:320px;max-width:520px;">
            <div id="pie_chart_found_summary" style="width:100%;height:320px;"></div>
          </div>
          <div class="card-summary-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px;min-width:320px;">
            <div class="card">
              <div class="card-title" style="font-weight:bold;font-size:1.15em;color:#667eea;display:flex;align-items:center;gap:8px;justify-content:center;">
                <span style="font-size:1.5em;">🏠</span> ในอาคาร
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 0 0;font-size:1.05em;">
                <span>💧 น้ำใช้</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['ในอาคาร-น้ำใช้']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['ในอาคาร-น้ำใช้'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>🥤 น้ำดื่ม</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['ในอาคาร-น้ำดื่ม']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['ในอาคาร-น้ำดื่ม'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>🚽 ห้องน้ำ</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['ในอาคาร-ห้องน้ำ']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['ในอาคาร-ห้องน้ำ'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>🌷 แจกัน/กระถาง</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['ในอาคาร-แจกันกระถาง']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['ในอาคาร-แจกันกระถาง'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>📊 อื่นๆ</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['ในอาคาร-อื่นๆ']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['ในอาคาร-อื่นๆ'])}%)</span>
              </div>
              <div style="margin-top:18px;font-size:1.08em;color:#333;display:flex;align-items:center;justify-content:space-between;">
                <span style="font-weight:600;">รวมในอาคาร</span>
                <b style="color:#667eea;">${totalIn}</b>
                <span class="card-unit" style="color:#636e72;">ภาชนะ</span>
              </div>
            </div>
            <div class="card">
              <div class="card-title" style="font-weight:bold;font-size:1.15em;color:#00b894;display:flex;align-items:center;gap:8px;justify-content:center;">
                <span style="font-size:1.5em;">🏡</span> นอกอาคาร
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin:18px 0 0 0;font-size:1.05em;">
                <span>💧 น้ำใช้</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['นอกอาคาร-น้ำใช้']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['นอกอาคาร-น้ำใช้'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>🥤 น้ำดื่ม</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['นอกอาคาร-น้ำดื่ม']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['นอกอาคาร-น้ำดื่ม'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>🚽 ห้องน้ำ</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['นอกอาคาร-ห้องน้ำ']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['นอกอาคาร-ห้องน้ำ'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>🌷 แจกัน/กระถาง</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['นอกอาคาร-แจกันกระถาง']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['นอกอาคาร-แจกันกระถาง'])}%)</span>
              </div>
              <div class="summary-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;font-size:1.05em;">
                <span>📊 อื่นๆ</span>
                <b style="color:#764ba2;min-width:40px;text-align:right;">${foundSummary['นอกอาคาร-อื่นๆ']}</b>
                <span class="card-unit" style="color:#636e72;font-size:0.95em;">(${percent(foundSummary['นอกอาคาร-อื่นๆ'])}%)</span>
              </div>
              <div style="margin-top:18px;font-size:1.08em;color:#333;display:flex;align-items:center;justify-content:space-between;">
                <span style="font-weight:600;">รวมนอกอาคาร</span>
                <b style="color:#00b894;">${totalOut}</b>
                <span class="card-unit" style="color:#636e72;">ภาชนะ</span>
              </div>
            </div>
          </div>
        </div>`;

        // วาด pie chart ด้วย Google Charts
        setTimeout(function() {
          if (window.google && google.visualization) {
            const pieData = new google.visualization.DataTable();
            pieData.addColumn('string', 'ประเภท');
            pieData.addColumn('number', 'จำนวน');
            pieData.addRows([
              ['💧 น้ำใช้', foundSummary['ในอาคาร-น้ำใช้'] + foundSummary['นอกอาคาร-น้ำใช้']],
              ['🥤 น้ำดื่ม', foundSummary['ในอาคาร-น้ำดื่ม'] + foundSummary['นอกอาคาร-น้ำดื่ม']],
              ['🚽 ห้องน้ำ', foundSummary['ในอาคาร-ห้องน้ำ'] + foundSummary['นอกอาคาร-ห้องน้ำ']],
              ['🌷 แจกัน/กระถาง', foundSummary['ในอาคาร-แจกันกระถาง'] + foundSummary['นอกอาคาร-แจกันกระถาง']],
              ['📊 อื่นๆ', foundSummary['ในอาคาร-อื่นๆ'] + foundSummary['นอกอาคาร-อื่นๆ']]
            ]);
            const pieOptions = {
              title: 'สัดส่วนการพบลูกน้ำแต่ละประเภท',
              pieHole: 0.4,
              legend: { position: 'right', textStyle: { fontSize: 15 } },
              chartArea: { left: 10, top: 40, width: '90%', height: '80%' },
              colors: ['#667eea','#764ba2','#00b894','#ffd600','#ff3b30'],
              fontName: 'Sarabun, Noto Sans Thai, Arial',
              backgroundColor: 'transparent',
              titleTextStyle: { fontSize: 18, color: '#333', bold: true }
            };
            const pieChart = new google.visualization.PieChart(document.getElementById('pie_chart_found_summary'));
            pieChart.draw(pieData, pieOptions);
          }
        }, 200);

        document.getElementById('table_div').innerHTML = html;
      }

      // เพิ่มฟังก์ชันสำหรับ responsive table
      function handleTableResponsive() {
        const table = document.querySelector('table');
        if (table && window.innerWidth < 768) {
          table.style.fontSize = '0.7em';
        } else if (table) {
          table.style.fontSize = '0.9em';
        }
      }

      // Event listeners
      window.addEventListener('resize', handleTableResponsive);
      window.addEventListener('load', handleTableResponsive);

      // Auto refresh every 5 minutes
      setInterval(() => {
        console.log('Auto refreshing data...');
        fetchData();
      }, 300000);

      // คำแนะนำการแก้ไขปัญหา CORS
      window.addEventListener('error', function(e) {
        if (e.message && e.message.includes('Script error')) {
          console.warn('Possible CORS issue detected. Please ensure:');
          console.warn('1. Google Sheet is shared publicly (Anyone with link can view)');
          console.warn('2. Open this file via web server (not file://)');
          console.warn('3. Use Chrome/Edge without strict privacy settings');
        }
      });

      // เพิ่ม keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'r':
              e.preventDefault();
              fetchData();
              break;
            case 'f':
              e.preventDefault();
              document.getElementById('dateSelect').focus();
              break;
          }
        }
      });

      // เพิ่ม tooltips สำหรับ CI values
      function addTooltips() {
        const ciElements = document.querySelectorAll('.ci-high, .ci-medium, .ci-low');
        ciElements.forEach(el => {
          const value = parseFloat(el.textContent);
          let tooltip = '';
          if (value > 10) {
            tooltip = 'ระดับเสี่ยงสูง - ต้องการการควบคุมเร่งด่วน';
          } else if (value > 5) {
            tooltip = 'ระดับเสี่ยงปานกลาง - ต้องการการติดตาม';
          } else {
            tooltip = 'ระดับเสี่ยงต่ำ - สถานการณ์ปกติ';
          }
          el.setAttribute('title', tooltip);
        });
      }

      // Call addTooltips after rendering
      const originalRenderDashboard = renderDashboard;
      renderDashboard = function() {
        originalRenderDashboard();
        setTimeout(addTooltips, 100);
      };
    </script>
  </body>
  </html>
